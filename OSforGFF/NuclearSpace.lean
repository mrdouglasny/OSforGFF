/-
Copyright (c) 2025 Michael R. Douglas, Sarah Hoback. All rights reserved.
Released under Apache 2.0 license as described in the file LICENSE.

# Nuclear Operators and Nuclear Spaces

Definitions of nuclear operators, Hilbertian seminorms, and nuclear spaces
via Hilbert-Schmidt embeddings. This characterization is adapted to
Schwartz/Fr√©chet spaces where a countable Hilbertian basis is available,
and suffices for the GFF construction via the Minlos theorem.

## Main definitions

- `IsNuclearMap` ‚Äî nuclear operator representation for maps between normed spaces
- `Seminorm.IsHilbertian` ‚Äî seminorms satisfying the parallelogram law
- `Seminorm.innerProd` ‚Äî inner product recovered from a Hilbertian seminorm
- `Seminorm.IsOrthonormalSeq` ‚Äî p-orthonormal finite sequences
- `Seminorm.IsHilbertSchmidtEmbedding` ‚Äî Hilbert-Schmidt condition on inclusions
- `NuclearSpace` ‚Äî nuclear space via Hilbertian seminorms with HS embeddings

## References

- Tr√®ves, "Topological Vector Spaces", Ch. 50-51
- Gel'fand-Vilenkin, "Generalized Functions" Vol. 4, Ch. 3-4
- Reed-Simon, "Methods of Modern Mathematical Physics" Vol. 1, ¬ßV.3
- Pietsch, "Nuclear Locally Convex Spaces"
-/

import Mathlib.Analysis.LocallyConvex.WithSeminorms
import Mathlib.Analysis.Distribution.SchwartzSpace.Deriv
import OSforGFF.NuclearSpace.Defs

open scoped BigOperators

noncomputable section

/-! ### Nuclear Operators

The hierarchy of operator conditions between normed spaces:
  nuclear (trace-class) ‚äÇ Hilbert-Schmidt ‚äÇ compact
-/

/-- Compatibility alias to the canonical nuclear-map API in `OSforGFF.NuclearSpace.Defs`.

This keeps the historical unqualified name `IsNuclearMap` available while ensuring both old
and new code use the same definition. -/
abbrev IsNuclearMap {E F : Type*}
    [NormedAddCommGroup E] [NormedSpace ‚Ñù E]
    [NormedAddCommGroup F] [NormedSpace ‚Ñù F] [CompleteSpace F]
    (T : E ‚ÜíL[‚Ñù] F) : Prop :=
  OSforGFF.IsNuclearMap (ùïú := ‚Ñù) T

/-! ### Hilbertian Seminorms -/

/-- A seminorm is **Hilbertian** (comes from an inner product) iff it satisfies
    the parallelogram law: p(x+y)¬≤ + p(x-y)¬≤ = 2(p(x)¬≤ + p(y)¬≤).

    The inner product can be recovered by polarization:
    ‚ü®x,y‚ü©_p = (p(x+y)¬≤ - p(x-y)¬≤) / 4. -/
def Seminorm.IsHilbertian {E : Type*} [AddCommGroup E] [Module ‚Ñù E]
    (p : Seminorm ‚Ñù E) : Prop :=
  ‚àÄ x y : E, p (x + y) ^ 2 + p (x - y) ^ 2 = 2 * (p x ^ 2 + p y ^ 2)

/-- The inner product induced by a Hilbertian seminorm via polarization. -/
noncomputable def Seminorm.innerProd {E : Type*} [AddCommGroup E] [Module ‚Ñù E]
    (p : Seminorm ‚Ñù E) (x y : E) : ‚Ñù :=
  (p (x + y) ^ 2 - p (x - y) ^ 2) / 4

/-- A finite sequence is **p-orthonormal**: ‚ü®e·µ¢, e‚±º‚ü©_p = Œ¥·µ¢‚±º. -/
def Seminorm.IsOrthonormalSeq {E : Type*} [AddCommGroup E] [Module ‚Ñù E]
    (p : Seminorm ‚Ñù E) {n : ‚Ñï} (e : Fin n ‚Üí E) : Prop :=
  ‚àÄ i j, p.innerProd (e i) (e j) = if i = j then 1 else 0

/-! ### Hilbert-Schmidt Embeddings -/

/-- The canonical inclusion √ä_p ‚Üí √ä_q is **Hilbert-Schmidt**: the sum ‚àë q(e‚Çñ)¬≤
    is uniformly bounded over all finite p-orthonormal sequences {e‚Çñ}.

    For diagonal operators with eigenvalues œÉ‚Çñ, this reduces to ‚àë œÉ‚Çñ¬≤ < ‚àû.
    For Schwartz space with Hermite basis and Sobolev norms ‚Äñf‚Äñ_k¬≤ = ‚àë n^{2k} |‚ü®f,h‚Çô‚ü©|¬≤,
    the inclusion from level k+s to level k has eigenvalues n^{-s}, and
    ‚àë n^{-2s} < ‚àû for s > ¬Ω. -/
def Seminorm.IsHilbertSchmidtEmbedding {E : Type*} [AddCommGroup E] [Module ‚Ñù E]
    (p q : Seminorm ‚Ñù E) : Prop :=
  q ‚â§ p ‚àß
  ‚àÉ (C : ‚Ñù), ‚àÄ (n : ‚Ñï) (e : Fin n ‚Üí E),
    p.IsOrthonormalSeq e ‚Üí
    ‚àë i, q (e i) ^ 2 ‚â§ C

/-! ### Nuclear Spaces -/

/-- A **nuclear space** is a locally convex space whose topology is generated by a
    countable family of Hilbertian seminorms with Hilbert-Schmidt inclusion maps.

    **Definition**: There exists a family of seminorms {p‚Çñ} such that:
    1. Each p‚Çñ is Hilbertian (comes from an inner product)
    2. The family generates the topology of E
    3. For every k, there exists k' > k such that the inclusion √ä_{k'} ‚Üí √ä_k
       is a Hilbert-Schmidt operator

    **Why this implies nuclearity**: For Fr√©chet spaces, Hilbert-Schmidt inclusions
    at every level imply that the composition of two consecutive inclusions is nuclear
    (trace-class), since HS ‚àò HS = nuclear. This gives the Grothendieck-Pietsch
    characterization.

    **Example (Schwartz space S(‚Ñù·µà))**: Take the Hermite basis {h‚Çô} (eigenfunctions
    of the harmonic oscillator H = -Œî + |x|¬≤) and define:
      ‚Äñf‚Äñ_k¬≤ = ‚àë‚Çô (1+n)^{2k} |‚ü®f, h‚Çô‚ü©|¬≤
    The inclusion from level k+s to level k is diagonal with eigenvalues (1+n)^{-s},
    and ‚àë‚Çô (1+n)^{-2s} < ‚àû for s > ¬Ω.

    **Non-examples**: ‚Ñì^p, L^p, and Banach spaces (except finite-dimensional) are NOT nuclear.

    **Equivalences** (for Fr√©chet spaces):
    - Every CLM to a Banach space is nuclear (Grothendieck-Pietsch)
    - œÄ-tensor product = Œµ-tensor product
    - Every continuous linear map factors through trace-class operators

    **Note**: This definition is not the most general characterization of nuclear spaces
    (which uses trace-class maps between arbitrary local Banach spaces). It is adapted
    to Schwartz/Fr√©chet spaces where a countable Hilbertian basis is available, which
    suffices for the GFF construction.

    **Reference:** Tr√®ves, "Topological Vector Spaces", Ch. 50, Thm 50.1;
    Gel'fand-Vilenkin Vol. 4, Ch. 3-4; Reed-Simon Vol. 1, ¬ßV.3. -/
class NuclearSpace (E : Type*) [AddCommGroup E] [Module ‚Ñù E] [TopologicalSpace E] : Prop where
  nuclear_hilbert_embeddings :
    ‚àÉ (p : ‚Ñï ‚Üí Seminorm ‚Ñù E),
      (‚àÄ n, (p n).IsHilbertian) ‚àß
      (WithSeminorms (fun n => p n)) ‚àß
      (‚àÄ n, ‚àÉ m, n < m ‚àß (p m).IsHilbertSchmidtEmbedding (p n))

end
