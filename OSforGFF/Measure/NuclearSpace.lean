/-
Copyright (c) 2025 Michael R. Douglas, Sarah Hoback. All rights reserved.
Released under Apache 2.0 license as described in the file LICENSE.

# Nuclear Operators and Nuclear Spaces

Definitions of nuclear operators, Hilbertian seminorms, and nuclear spaces
via Hilbert-Schmidt embeddings. This characterization is adapted to
Schwartz/FrÃ©chet spaces where a countable Hilbertian basis is available,
and suffices for the GFF construction via the Minlos theorem.

## Main definitions

- `IsNuclearMap` â€” nuclear operator representation for maps between normed spaces
- `Seminorm.IsHilbertian` â€” seminorms satisfying the parallelogram law
- `Seminorm.innerProd` â€” inner product recovered from a Hilbertian seminorm
- `Seminorm.IsOrthonormalSeq` â€” p-orthonormal finite sequences
- `Seminorm.IsHilbertSchmidtEmbedding` â€” Hilbert-Schmidt condition on inclusions
- `NuclearSpace` â€” nuclear space via Hilbertian seminorms with HS embeddings
- `schwartz_nuclear` â€” axiom: Schwartz space is nuclear

## References

- TrÃ¨ves, "Topological Vector Spaces", Ch. 50-51
- Gel'fand-Vilenkin, "Generalized Functions" Vol. 4, Ch. 3-4
- Reed-Simon, "Methods of Modern Mathematical Physics" Vol. 1, Â§V.3
- Pietsch, "Nuclear Locally Convex Spaces"
-/

import Mathlib.Analysis.LocallyConvex.WithSeminorms
import Mathlib.Analysis.Distribution.SchwartzSpace.Deriv

open scoped BigOperators

noncomputable section

/-! ### Nuclear Operators

The hierarchy of operator conditions between normed spaces:
  nuclear (trace-class) âŠ‚ Hilbert-Schmidt âŠ‚ compact
-/

/-- A continuous linear map between normed spaces is **nuclear** if it admits a
    representation T(x) = âˆ‘â‚™ (Ï†â‚™ x) â€¢ yâ‚™ where âˆ‘â‚™ â€–Ï†â‚™â€– Â· â€–yâ‚™â€– < âˆ. -/
def IsNuclearMap {E F : Type*}
    [NormedAddCommGroup E] [NormedSpace â„ E]
    [NormedAddCommGroup F] [NormedSpace â„ F] [CompleteSpace F]
    (T : E â†’L[â„] F) : Prop :=
  âˆƒ (Ï† : â„• â†’ (E â†’L[â„] â„)) (y : â„• â†’ F),
    Summable (fun n => â€–Ï† nâ€– * â€–y nâ€–) âˆ§
    âˆ€ x, T x = âˆ‘' n, (Ï† n x) â€¢ y n

/-! ### Hilbertian Seminorms -/

/-- A seminorm is **Hilbertian** (comes from an inner product) iff it satisfies
    the parallelogram law: p(x+y)Â² + p(x-y)Â² = 2(p(x)Â² + p(y)Â²).

    The inner product can be recovered by polarization:
    âŸ¨x,yâŸ©_p = (p(x+y)Â² - p(x-y)Â²) / 4. -/
def Seminorm.IsHilbertian {E : Type*} [AddCommGroup E] [Module â„ E]
    (p : Seminorm â„ E) : Prop :=
  âˆ€ x y : E, p (x + y) ^ 2 + p (x - y) ^ 2 = 2 * (p x ^ 2 + p y ^ 2)

/-- The inner product induced by a Hilbertian seminorm via polarization. -/
noncomputable def Seminorm.innerProd {E : Type*} [AddCommGroup E] [Module â„ E]
    (p : Seminorm â„ E) (x y : E) : â„ :=
  (p (x + y) ^ 2 - p (x - y) ^ 2) / 4

/-- A finite sequence is **p-orthonormal**: âŸ¨eáµ¢, eâ±¼âŸ©_p = Î´áµ¢â±¼. -/
def Seminorm.IsOrthonormalSeq {E : Type*} [AddCommGroup E] [Module â„ E]
    (p : Seminorm â„ E) {n : â„•} (e : Fin n â†’ E) : Prop :=
  âˆ€ i j, p.innerProd (e i) (e j) = if i = j then 1 else 0

/-! ### Hilbert-Schmidt Embeddings -/

/-- The canonical inclusion ÃŠ_p â†’ ÃŠ_q is **Hilbert-Schmidt**: the sum âˆ‘ q(eâ‚–)Â²
    is uniformly bounded over all finite p-orthonormal sequences {eâ‚–}.

    For diagonal operators with eigenvalues Ïƒâ‚–, this reduces to âˆ‘ Ïƒâ‚–Â² < âˆ.
    For Schwartz space with Hermite basis and Sobolev norms â€–fâ€–_kÂ² = âˆ‘ n^{2k} |âŸ¨f,hâ‚™âŸ©|Â²,
    the inclusion from level k+s to level k has eigenvalues n^{-s}, and
    âˆ‘ n^{-2s} < âˆ for s > Â½. -/
def Seminorm.IsHilbertSchmidtEmbedding {E : Type*} [AddCommGroup E] [Module â„ E]
    (p q : Seminorm â„ E) : Prop :=
  q â‰¤ p âˆ§
  âˆƒ (C : â„), âˆ€ (n : â„•) (e : Fin n â†’ E),
    p.IsOrthonormalSeq e â†’
    âˆ‘ i, q (e i) ^ 2 â‰¤ C

/-! ### Nuclear Spaces -/

/-- A **nuclear space** is a locally convex space whose topology is generated by a
    countable family of Hilbertian seminorms with Hilbert-Schmidt inclusion maps.

    **Definition**: There exists a family of seminorms {pâ‚–} such that:
    1. Each pâ‚– is Hilbertian (comes from an inner product)
    2. The family generates the topology of E
    3. For every k, there exists k' > k such that the inclusion ÃŠ_{k'} â†’ ÃŠ_k
       is a Hilbert-Schmidt operator

    **Why this implies nuclearity**: For FrÃ©chet spaces, Hilbert-Schmidt inclusions
    at every level imply that the composition of two consecutive inclusions is nuclear
    (trace-class), since HS âˆ˜ HS = nuclear. This gives the Grothendieck-Pietsch
    characterization.

    **Example (Schwartz space S(â„áµˆ))**: Take the Hermite basis {hâ‚™} (eigenfunctions
    of the harmonic oscillator H = -Î” + |x|Â²) and define:
      â€–fâ€–_kÂ² = âˆ‘â‚™ (1+n)^{2k} |âŸ¨f, hâ‚™âŸ©|Â²
    The inclusion from level k+s to level k is diagonal with eigenvalues (1+n)^{-s},
    and âˆ‘â‚™ (1+n)^{-2s} < âˆ for s > Â½.

    **Non-examples**: â„“^p, L^p, and Banach spaces (except finite-dimensional) are NOT nuclear.

    **Equivalences** (for FrÃ©chet spaces):
    - Every CLM to a Banach space is nuclear (Grothendieck-Pietsch)
    - Ï€-tensor product = Îµ-tensor product
    - Every continuous linear map factors through trace-class operators

    **Note**: This definition is not the most general characterization of nuclear spaces
    (which uses trace-class maps between arbitrary local Banach spaces). It is adapted
    to Schwartz/FrÃ©chet spaces where a countable Hilbertian basis is available, which
    suffices for the GFF construction.

    **Reference:** TrÃ¨ves, "Topological Vector Spaces", Ch. 50, Thm 50.1;
    Gel'fand-Vilenkin Vol. 4, Ch. 3-4; Reed-Simon Vol. 1, Â§V.3. -/
class NuclearSpace (E : Type*) [AddCommGroup E] [Module â„ E] [TopologicalSpace E] : Prop where
  nuclear_hilbert_embeddings :
    âˆƒ (p : â„• â†’ Seminorm â„ E),
      (âˆ€ n, (p n).IsHilbertian) âˆ§
      (WithSeminorms (fun n => p n)) âˆ§
      (âˆ€ n, âˆƒ m, n < m âˆ§ (p m).IsHilbertSchmidtEmbedding (p n))

/-! ### Schwartz Space is Nuclear -/

/-- **Schwartz space is nuclear**: For any finite-dimensional real normed space E
    and any real normed space F, the Schwartz space ğ“¢(E, F) is a nuclear space.

    **Proof sketch** (Gel'fand-Vilenkin Vol. 4, Thm 3 in Ch. 4; TrÃ¨ves Ch. 51):
    The Hermite functions {hâ‚™} form an ONB for LÂ²(â„áµˆ) and are eigenfunctions of the
    harmonic oscillator H = -Î” + |x|Â². The Sobolev-Hermite norms
      â€–fâ€–_kÂ² = âˆ‘â‚™ (1+n)^{2k} |âŸ¨f, hâ‚™âŸ©|Â²
    are Hilbertian and generate the Schwartz topology. The inclusion from level k+1
    to level k has eigenvalues (1+n)^{-1}, and âˆ‘â‚™ (1+n)^{-2} = Ï€Â²/6 < âˆ,
    so each inclusion is Hilbert-Schmidt. -/
axiom schwartz_nuclear {E F : Type*}
    [NormedAddCommGroup E] [NormedSpace â„ E] [FiniteDimensional â„ E]
    [NormedAddCommGroup F] [NormedSpace â„ F] :
    NuclearSpace (SchwartzMap E F)

end
